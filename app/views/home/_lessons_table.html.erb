<div id="lessons_wrapper" data-start="<%= @week_days.first %>" data-student-id="<%= defined?(student) && student ? student.id : '' %>">
  <table id="lessons_table">
    <thead>
      <tr>
        <th class="first_column"></th>
        <% @week_days.each do |day| %>
          <th>
            <%= day.strftime("%m/%d") %><br>
            (<%= @days[day.wday] %>)
          </th>
        <% end %>
      </tr>
    </thead>

    <tbody>
      <% 4.times do |period| %>
        <tr>
          <th class="first_column period_column"><%= period + 1 %>コマ</th>

          <% @week_days.each do |day| %>
            <% lesson = (defined?(lessons) ? lessons : @lessons).detect do |l|
                 l.period_number == period + 1 && l.date == day
               end %>

            <td class="lesson_cell <%= 'attendance-locked' if lesson && lesson.is_attendance.to_i != 0 %>"
                data-lesson-id="<%= lesson&.id %>"
                data-is-attendance="<%= lesson&.is_attendance.to_i %>">
              <div class="lesson-inner">

                <% if lesson %>
                  <div class="lesson-main" style="display:flex;flex-direction:column;justify-content:space-between;height:100%;">
                    <!-- 上: 教科名 -->
                    <div class="subject-top">
                      <span class="lesson-subject"><%= lesson.subject %></span>
                    </div>

                    <!-- 下: 出欠マーク -->
                    <div class="attendance-bottom" style="margin-top:8px;">
                      <% case lesson.is_attendance %>
                      <% when 1 %>
                        <span class="lesson-attendance att-present" title="出席">〇</span>
                      <% when 2 %>
                        <span class="lesson-attendance att-absent" role="button" tabindex="0" data-absence-reason="<%= h(lesson.absence_reason.to_s) %>">×</span>
                        <div class="absence-tooltip" aria-hidden="true"><%= h(lesson.absence_reason.to_s) %></div>
                      <% else %>
                        <span class="lesson-attendance att-none">-</span>
                      <% end %>
                    </div>
                  </div>

                  <!-- ホバーで表示するボタン群 -->
                  <div class="attendance-controls" aria-hidden="true">
                    <button class="present-btn" type="button" data-lesson-id="<%= lesson.id %>">出席</button>
                    <button class="absent-btn" type="button" data-lesson-id="<%= lesson.id %>">欠席</button>
                  </div>

                  <!-- 欠席入力パネル（初期は非表示） -->
                  <div class="absence-panel" aria-hidden="true">
                    <textarea class="absence-reason" placeholder="欠席理由を記入してください" rows="3"></textarea>
                    <div class="absence-actions">
                      <button class="absence-cancel" type="button">取消</button>
                      <button class="absence-confirm" type="button" data-lesson-id="<%= lesson.id %>">欠席確定</button>
                    </div>
                  </div>

                <% else %>
                  -
                <% end %>

              </div>
            </td>
          <% end %>

        </tr>
      <% end %>
    </tbody>
  </table>

  <div class="lessons-nav" style="text-align: right; margin-top: 8px;">
    <button class="week-nav prev-week" type="button" data-direction="-1" aria-label="前週へ">◀ 前週</button>
    <button class="week-nav next-week" type="button" data-direction="1" aria-label="次週へ">次週 ▶</button>
  </div>
</div>
